default_platform(:android)

platform :android do

    # Upload the new build to Google Play Store
    desc "Deploy app to Play Store production track"
    lane :deploy_to_production do |options|
        # Read the service account credentials file
        service_account_data = JSON.parse(File.read("../path/to/your/play-store-credentials.json")) # Replace with your actual credentials path
        json_key_data = JSON.generate(service_account_data)

        # Update version properties
        update_version_properties(
            build_number: options[:build_number]
        )
        # clean the gradle
        gradle(
            task: 'clean'
        )
        
        # Build the release AAB
        gradle(
            task: 'bundleRelease'
        )
        
        # Upload to Google Play Store production track
        upload_to_play_store(
            track: 'production',
            package_name: "com.yourdomain.appname", # Replace with your actual package name
            track_promote_to: 'production',
            json_key_data: json_key_data,
            aab: 'app/build/outputs/bundle/release/app-release.aab',
            skip_upload_metadata: true,
            skip_upload_images: true,
            skip_upload_screenshots: true
        )
    end


    # Lane to update version properties in gradle.properties
    # In gradle.properties file you need to set the versionCode and versionName
    # e.g:
    # versionCode=1
    # versionName=1.0
    #
    # Then update android/app/build.gradle file with:
    # versionCode project.versionCode.toInteger()
    # versionName project.versionName
    desc "Update version properties in gradle.properties"
    lane :update_version_properties do |options|
        gradle_properties_path = "../gradle.properties"
    
        # Read the contents of gradle.properties
        gradle_properties_file = File.read(gradle_properties_path)
    
        # Extract current versionCode and versionName
        current_version_code = gradle_properties_file[/^versionCode=(\d+)/, 1].to_i
        current_version_name = gradle_properties_file[/^versionName=([\d.]+)/, 1]
    
        # Increment versionCode
        new_version_code = current_version_code + 1
    
        # Update version properties in gradle.properties
        gradle_properties_file.gsub!(/^versionCode=\d+$/, "versionCode=#{new_version_code}")
    
        # Write back the updated gradle.properties
        File.write(gradle_properties_path, gradle_properties_file)
    end
end